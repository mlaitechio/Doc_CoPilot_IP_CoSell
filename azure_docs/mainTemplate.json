{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": { "description": "Location for all resources" }
    },
    "projectName": {
      "type": "string",
      "metadata": { "description": "Base name for all resources (e.g., doccopilot)" }
    },
    "aiFoundryName": {
      "type": "string",
      "metadata": { "description": "Name for Azure AI Foundry workspace" }
    },
    "aiFoundryHubName": {
      "type": "string",
      "metadata": { "description": "Name for Azure AI Foundry hub" }
    },
    "computerVisionName": {
      "type": "string",
      "metadata": { "description": "Name for Azure Computer Vision resource" }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": { "description": "Name for Azure Blob Storage account (must be globally unique)" }
    },
    "sqlServerName": {
      "type": "string",
      "metadata": { "description": "Name for Azure SQL Server" }
    },
    "sqlAdminUsername": {
      "type": "string",
      "metadata": { "description": "SQL Server administrator username" }
    },
    "sqlAdminPassword": {
      "type": "securestring",
      "metadata": { "description": "SQL Server administrator password" }
    },
    "databaseName": {
      "type": "string",
      "defaultValue": "DocumentCoPilotDB",
      "metadata": { "description": "Name for SQL Database" }
    },
    "vmName": {
      "type": "string",
      "metadata": { "description": "Name for the application VM" }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v3",
      "metadata": { "description": "Size of the VM" }
    },
    "adminUsername": {
      "type": "string",
      "metadata": { "description": "VM administrator username" }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": { "description": "VM administrator password" }
    }
  },
  "variables": {
    "vnetName": "[concat(parameters('vmName'), '-vnet')]",
    "subnetName": "[concat(parameters('vmName'), '-subnet')]",
    "nsgName": "[concat(parameters('vmName'), '-nsg')]",
    "nicName": "[concat(parameters('vmName'), '-nic')]",
    "publicIpName": "[concat(parameters('vmName'), '-pip')]",
    "workspaceName": "[concat(parameters('projectName'), '-workspace')]",
    "appInsightsName": "[concat(parameters('projectName'), '-insights')]",
    "keyVaultName": "[concat(parameters('projectName'), '-kv-', uniqueString(resourceGroup().id))]",
    "entraAppName": "[concat(parameters('projectName'), '-entra-app')]",
    "aiServicesName": "[concat(parameters('projectName'), '-aiservices')]"
  },
  "resources": [
    {
      "type": "Microsoft.Entra/applications",
      "apiVersion": "2024-03-01-preview",
      "name": "[variables('entraAppName')]",
      "location": "[parameters('location')]",
      "properties": {
        "displayName": "[variables('entraAppName')]",
        "signInAudience": "AzureADMyOrg",
        "web": {
          "redirectUris": [
            "http://localhost:8501",
            "https://localhost:8501"
          ]
        }
      },
      "tags": {
        "component": "MicrosoftEntraID",
        "project": "DocumentCoPilot"
      }
    },
    {
      "type": "Microsoft.MachineLearningServices/workspaces",
      "apiVersion": "2023-10-01",
      "name": "[parameters('aiFoundryHubName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Basic", "tier": "Basic" },
      "kind": "Hub",
      "identity": { "type": "SystemAssigned" },
      "properties": {
        "friendlyName": "[parameters('aiFoundryHubName')]",
        "description": "Azure AI Foundry Hub for Document CoPilot System",
        "storageAccount": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "keyVault": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "applicationInsights": "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]",
        "[resourceId('Microsoft.Insights/components', variables('appInsightsName'))]"
      ],
      "tags": { "component": "AIFoundryHub", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.MachineLearningServices/workspaces",
      "apiVersion": "2023-10-01",
      "name": "[parameters('aiFoundryName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Basic", "tier": "Basic" },
      "kind": "Project",
      "identity": { "type": "SystemAssigned" },
      "properties": {
        "friendlyName": "[parameters('aiFoundryName')]",
        "description": "Azure AI Foundry Project for Document CoPilot",
        "hubResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiFoundryHubName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiFoundryHubName'))]"
      ],
      "tags": { "component": "AIFoundryProject", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.CognitiveServices/accounts",
      "apiVersion": "2023-05-01",
      "name": "[parameters('computerVisionName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "S1" },
      "kind": "ComputerVision",
      "properties": {
        "customSubDomainName": "[parameters('computerVisionName')]",
        "publicNetworkAccess": "Enabled"
      },
      "tags": { "component": "ComputerVision", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('workspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": { "name": "PerGB2018" },
        "retentionInDays": 30
      },
      "tags": { "component": "LogAnalytics", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('appInsightsName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      ],
      "properties": {
        "Application_Type": "web",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
      },
      "tags": { "component": "AppInsights", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2022-07-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": { "family": "A", "name": "standard" },
        "tenantId": "[subscription().tenantId]",
        "enabledForDeployment": true,
        "enableRbacAuthorization": true
      },
      "tags": { "component": "KeyVault", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": { "name": "Standard_LRS" },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "supportsHttpsTrafficOnly": true
      },
      "tags": { "component": "BlobStorage", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2022-05-01-preview",
      "name": "[parameters('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[parameters('sqlAdminUsername')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "version": "12.0",
        "publicNetworkAccess": "Enabled"
      },
      "tags": { "component": "SQLServer", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2022-05-01-preview",
      "name": "[concat(parameters('sqlServerName'), '/', parameters('databaseName'))]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', parameters('sqlServerName'))]"
      ],
      "sku": { "name": "S1", "tier": "Standard", "capacity": 20 },
      "properties": {
        "collation": "SQL_Latin1_General_CP1_CI_AS"
      },
      "tags": { "component": "SQLDatabase", "project": "DocumentCoPilot" }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-09-01",
      "name": "[parameters('vmName')]",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": { "vmSize": "[parameters('vmSize')]" },
        "osProfile": {
          "computerName": "[parameters('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "linuxConfiguration": { "disablePasswordAuthentication": false }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": { "storageAccountType": "Premium_LRS" },
            "diskSizeGB": 128
          }
        }
      },
      "tags": { "component": "ApplicationVM", "project": "DocumentCoPilot" }
    }
  ],
  "outputs": {
    "entraAppName": { "type": "string", "value": "[variables('entraAppName')]" },
    "aiFoundryHubId": { "type": "string", "value": "[resourceId('Microsoft.MachineLearningServices/workspaces', parameters('aiFoundryHubName'))]" },
    "computerVisionEndpoint": { "type": "string", "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('computerVisionName'))).endpoint]" },
    "storageAccountName": { "type": "string", "value": "[parameters('storageAccountName')]" },
    "sqlServerName": { "type": "string", "value": "[parameters('sqlServerName')]" },
    "workspaceId": { "type": "string", "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]" }
  }
}
